Data[Data$state.name == state.ind,]$group  <- 1
Data[Data$state.name == state.ind,]$state  <- 34
if (state.ind == 'National') {
Data$group    <- factor(Data$group, levels = c(1,3), labels = c('National','Rest of states'))
colors.trends <- c('black','lightgrey')
} else {
Data$group <- factor(Data$group, levels = 1:3, labels = c(state.ind,'National','Rest of states'))
colors.trends <- c('black', 'red', 'lightgrey')
}
p <-ggplot(Data[Data$age==0,], aes(x = year,y = ex,colour=group)) +
ggtitle('Life expectancy at birth') +
geom_line(aes(group = state), size= 1.2) +
facet_wrap(~sex)+
theme_light()+
labs(y = "Years")+
scale_colour_manual('State', values = colors.trends) +
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))
p
q <-ggplot(Data[Data$age==0,], aes(x = year,y = e.dagger,colour=(group))) +
ggtitle('Life expectancy at birth') +
geom_line(aes(group = state), size= 1.2) +
facet_wrap(~sex)+
theme_light()+
labs(y = "Years")+
scale_colour_manual('State', values = colors.trends) +
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))
q
library(ggthemes)
library(ggplot2)
library(plotly)
library(RColorBrewer)
library(data.table)
library(reshape2)
state.ind   <- 'National'
initial.ind <- 1995
final.ind   <- 2005
Data = DT.Decomp.ex
state = state.ind
initial = initial.ind
final = final.ind
colnames(Data)
colnames(Data) <- c('Name','Region','Sex','State','year','age1',1:16)
colnames(Data)
Data.melt               <- melt(Data, id.vars = 1:6,variable.name = 'Cause',value.name = 'Contribution')
Data.melt
levels(Data.melt$Cause)
levels(Data.melt$Cause) <- c('Infect & respiratory','Cancers','Circulatory','Birth conditions',
'Diabetes','Other AMS','IHD','HIV','Suicide','Lung Cancer','Cirrhosis',
'Homicide','Traffic accidents','Other HD','Ill-Defined','Rest')
Labels.age            <- c('0-4', '5-9', '10-14', '15-19', '20-24','25-29','30-34','35-39',
'40-44','45-49','50-54','55-59','60-64','65-69',
"70-74","75-79","80-84","85-89","90-94","95-99","100-104","105+")
Data.melt$Age       <- (cut(Data.melt$age1+1, breaks=c(seq(0,105,5),Inf),labels=Labels.age))
Data.melt5 <- Data.melt[,list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,year,Cause,Age)]
Data.fig   <- Data.melt5[Data.melt5$year >= initial & Data.melt5$year < final, ]
Data.fig   <- Data.fig[, list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,Cause,Age)]
Data.fig   <- Data.fig[Data.fig$Name == state,]
Data.fig$Contribution <- round(Data.fig$Contribution,2)
Data.fig
}
getData.function <- function(Data = DT.Decomp.ex,state = state.ind,initial = initial.ind,final = final.ind){
colnames(Data) <- c('Name','Region','Sex','State','year','age1',1:16)
Data.melt               <- melt(Data, id.vars = 1:6,variable.name = 'Cause',value.name = 'Contribution')
levels(Data.melt$Cause) <- c('Infect & respiratory','Cancers','Circulatory','Birth conditions',
'Diabetes','Other AMS','IHD','HIV','Suicide','Lung Cancer','Cirrhosis',
'Homicide','Traffic accidents','Other HD','Ill-Defined','Rest')
Labels.age            <- c('0-4', '5-9', '10-14', '15-19', '20-24','25-29','30-34','35-39',
'40-44','45-49','50-54','55-59','60-64','65-69',
"70-74","75-79","80-84","85-89","90-94","95-99","100-104","105+")
Data.melt$Age       <- (cut(Data.melt$age1+1, breaks=c(seq(0,105,5),Inf),labels=Labels.age))
Data.melt5 <- Data.melt[,list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,year,Cause,Age)]
Data.fig   <- Data.melt5[Data.melt5$year >= initial & Data.melt5$year < final, ]
Data.fig   <- Data.fig[, list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,Cause,Age)]
Data.fig   <- Data.fig[Data.fig$Name == state,]
Data.fig$Contribution <- round(Data.fig$Contribution,2)
Data.fig
}
Data2 = DT.Decomp.ex
Data <- cbind(Data2[,1:6], AMS = rowSums(Data2[,c(7,10,8,9,12)]), Diabetes = Data2[,c(11)], IHD = Data2[,c(13)],
LungCancer = Data2[,c(16)], Cirrhosis = Data2[,c(17)],Homicide = Data2[,c(18)],TAcc = Data2[,c(19)],
Rest = rowSums(Data2[,c(14,21,15,20,22)]))
colnames(Data)
colnames(Data) <- c('Name','Region','Sex','State','year','age1',1:8)
colnames(Data)
getData.function <- function(Data = DT.Decomp.ex,state = state.ind,initial = initial.ind,final = final.ind){
colnames(Data) <- c('Name','Region','Sex','State','year','age1',1:16)
Data.melt               <- melt(Data, id.vars = 1:6,variable.name = 'Cause',value.name = 'Contribution')
levels(Data.melt$Cause) <- c('Infect & respiratory','Cancers','Circulatory','Birth conditions',
'Diabetes','Other AMS','IHD','HIV','Suicide','Lung Cancer','Cirrhosis',
'Homicide','Traffic accidents','Other HD','Ill-Defined','Rest')
Labels.age            <- c('0-4', '5-9', '10-14', '15-19', '20-24','25-29','30-34','35-39',
'40-44','45-49','50-54','55-59','60-64','65-69',
"70-74","75-79","80-84","85-89","90-94","95-99","100-104","105+")
Data.melt$Age       <- (cut(Data.melt$age1+1, breaks=c(seq(0,105,5),Inf),labels=Labels.age))
Data.melt5 <- Data.melt[,list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,year,Cause,Age)]
Data.fig   <- Data.melt5[Data.melt5$year >= initial & Data.melt5$year < final, ]
Data.fig   <- Data.fig[, list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,Cause,Age)]
Data.fig   <- Data.fig[Data.fig$Name == state,]
Data.fig$Contribution <- round(Data.fig$Contribution,2)
Data.fig
}
getData.function.g <- function(Data2 = DT.Decomp.ex,state = state.ind,initial = initial.ind,final = final.ind){
Data <- cbind(Data2[,1:6], AMS = rowSums(Data2[,c(7,10,8,9,12)]), Diabetes = Data2[,c(11)], IHD = Data2[,c(13)],
LungCancer = Data2[,c(16)], Cirrhosis = Data2[,c(17)],Homicide = Data2[,c(18)],TAcc = Data2[,c(19)],
Rest = rowSums(Data2[,c(14,21,15,20,22)]))
colnames(Data) <- c('Name','Region','Sex','State','year','age1',1:8)
Data.melt               <- melt(Data, id.vars = 1:6,variable.name = 'Cause',value.name = 'Contribution')
levels(Data.melt$Cause) <- c('AMS','Diabetes','IHD','Lung Cancer','Cirrhosis',
'Homicide','Traffic accidents','Rest')
Data.melt <- Data.melt[Data.melt$age1 < 100,]
Labels.age            <- c('0-4', '5-9', '10-14', '15-19', '20-24','25-29','30-34','35-39',
'40-44','45-49','50-54','55-59','60-64','65-69',
"70-74","75-79","80-84","85-89","90-94","95+")
Data.melt$Age       <- (cut(Data.melt$age1+1, breaks=c(seq(0,95,5),Inf),labels=Labels.age))
Data.melt5 <- Data.melt[,list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,year,Cause,Age)]
Data.fig   <- Data.melt5[Data.melt5$year >= initial & Data.melt5$year < final, ]
Data.fig   <- Data.fig[, list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,Cause,Age)]
Data.fig   <- Data.fig[Data.fig$Name == state,]
Data.fig$Contribution <- round(Data.fig$Contribution,2)
Data.fig
}
Data.fig <- getData.function(Data = DT.Decomp.ex)
Data.fig <- getData.function.g(Data2 = DT.Decomp.ex)
unique(Data.fig$Cause)
display.brewer.pal(8,name = 'Pastel2')
display.brewer.all()
base2 <- c(1:15)
base2 <- c(rev(brewer.pal(8,name = 'Spectral'))[1:5],rev(brewer.pal(8,name = 'Spectral'))[8],rev(brewer.pal(8,name = 'Spectral'))[7],'lightgrey')
base2 <- c(1:15)
base2 <- c(rev(brewer.pal(8,name = 'Spectral'))[1:5],rev(brewer.pal(8,name = 'Spectral'))[8],rev(brewer.pal(8,name = 'Spectral'))[7],'lightgrey')
# Figures for life expectancy at birth ------------------------------------
#First with 1995-2005
State   <- 'National'
Initial <- 1995
Final   <- 2005
sex     <- 'Males'
Data.fig        <- getData.function.g(Data2 = DT.Decomp.ex,state = State,initial = Initial,final = Final)
Data.fig$Period <- paste0(Initial,'-',Final)
Data.fig        <- Data.fig[Data.fig$Sex == sex,]
# Get life expectancies
e01     <- round(DT.LTmx[DT.LTmx$state.name == State & DT.LTmx$year ==  Initial & DT.LTmx$sex == 'Males']$ex[1],2)
e02     <- round(DT.LTmx[DT.LTmx$state.name == State & DT.LTmx$year ==  Final & DT.LTmx$sex == 'Males']$ex[1],2)
dife0   <- e02-e01
Total.cause <- Data.fig[,list(Contribution = sum(Contribution)), by = list(Cause)]
sum(Total.cause$Contribution)
Total.Age <- Data.fig[,list(Contribution = sum(Contribution)), by = list(Age)]
sum(Total.Age$Contribution)
Total.Age$Contribution <- round(Total.Age$Contribution,2)
ylim1 <- min(Data.fig$Contribution)
cause.name.vec      <- levels(Data.fig$Cause)
cause.code          <- unique(Data.fig$Cause)
cause.lab <- paste(cause.name.vec,'(',as.character(round(Total.cause$Contribution,2)),')')
text.1 <- paste('Numbers in boxes are age-specific contributions')
# Better to do separately to get the subtotal by causes of death
ex.males1 <- ggplot(Data.fig, aes(x = Age, y = Contribution, fill = Cause)) +
ggtitle(paste0('A ', Initial,'-',Final), subtitle = bquote(e[.(Initial)] == .(e01)~',' ~ e[.(Final)] == .(e02) ~'. Difference in life expectancy ='~ .(dife0) ) )+
ylim(-.18, .9)+
scale_fill_manual(name= ' Cause of death (Contribution)',values=base2,labels = cause.lab)+
geom_bar(aes(group = Cause), stat = "identity",position = "stack")+
theme_light()+
geom_label(aes(Age, -.17, label = Contribution,fill=NULL),size=3,show.legend = FALSE, data = Total.Age)+
theme(text = element_text(size=12),
axis.text.x = element_text(angle=45, hjust=1))+
labs(x = "Age group", y = "Contribution (years)",size=12)+
theme(axis.title.y = element_text(size = 12, angle = 90))+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(legend.position = c(.75,.75))+
annotate("text", x=-Inf, y=-Inf,hjust=1,vjust=1, label= text.1,size=6) +
geom_hline(yintercept = 0)+coord_flip()
ex.males1
#Now 2005-2015
State   <- 'National'
Initial <- 2005
Final   <- 2015
sex     <- 'Males'
Data.fig        <- getData.function.g(Data2 = DT.Decomp.ex,state = State,initial = Initial,final = Final)
Data.fig$Period <- paste0(Initial,'-',Final)
Data.fig        <- Data.fig[Data.fig$Sex == sex,]
# Get life expectancies
e01     <- round(DT.LTmx[DT.LTmx$state.name == State & DT.LTmx$year ==  Initial & DT.LTmx$sex == 'Males']$ex[1],2)
e02     <- round(DT.LTmx[DT.LTmx$state.name == State & DT.LTmx$year ==  Final & DT.LTmx$sex == 'Males']$ex[1],2)
dife0   <- e02-e01
Total.cause <- Data.fig[,list(Contribution = sum(Contribution)), by = list(Cause)]
sum(Total.cause$Contribution)
Total.Age <- Data.fig[,list(Contribution = sum(Contribution)), by = list(Age)]
sum(Total.Age$Contribution)
Total.Age$Contribution <- round(Total.Age$Contribution,2)
ylim1 <- min(Data.fig$Contribution)
cause.name.vec      <- levels(Data.fig$Cause)
cause.code          <- unique(Data.fig$Cause)
cause.lab <- paste(cause.name.vec,'(',as.character(round(Total.cause$Contribution,2)),')')
text.1 <- paste('Numbers in boxes are age-specific contributions')
# Better to do separately to get the subtotal by causes of death
ex.males2 <- ggplot(Data.fig, aes(x = Age, y = Contribution, fill = Cause)) +
ggtitle(paste0('B ',Initial,'-',Final), subtitle = bquote(e[.(Initial)] == .(e01)~',' ~ e[.(Final)] == .(e02) ~'. Difference in life expectancy ='~ .(dife0) ) )+
ylim(-.18, .9)+
scale_fill_manual(name= ' Cause of death (Contribution)',values=base2,labels = cause.lab)+
geom_bar(aes(group = Cause), stat = "identity",position = "stack")+
theme_light()+
geom_label(aes(Age, -.175, label = Contribution,fill=NULL),size=3,show.legend = FALSE, data = Total.Age)+
theme(text = element_text(size=12),
axis.text.x = element_text(angle=45, hjust=1))+
labs(x = "Age group", y = "Contribution (years)",size=12)+
theme(axis.title.y = element_text(size = 12, angle = 90))+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(legend.position = c(.75,.75))+
annotate("text", x=-Inf, y=-Inf,hjust=1,vjust=1, label= text.1,size=6) +
geom_hline(yintercept = 0)+coord_flip()
ex.males2
#First with 1995-2005
State   <- 'National'
Initial <- 1995
Final   <- 2005
sex     <- 'Males'
Data.fig        <- getData.function.g(Data2 = DT.Decomp.ed,state = State,initial = Initial,final = Final)
Data.fig$Period <- paste0(Initial,'-',Final)
Data.fig        <- Data.fig[Data.fig$Sex == sex,]
# Get life expectancies
e01     <- round(DT.LTmx[DT.LTmx$state.name == State & DT.LTmx$year ==  Initial& DT.LTmx$sex == 'Males']$e.dagger[1],2)
e02     <- round(DT.LTmx[DT.LTmx$state.name == State & DT.LTmx$year ==  Final& DT.LTmx$sex == 'Males']$e.dagger[1],2)
dife0   <- e02-e01
Total.cause <- Data.fig[,list(Contribution = sum(Contribution)), by = list(Cause)]
sum(Total.cause$Contribution)
Total.Age <- Data.fig[,list(Contribution = sum(Contribution)), by = list(Age)]
sum(Total.Age$Contribution)
Total.Age$Contribution <- round(Total.Age$Contribution,2)
cause.name.vec      <- levels(Data.fig$Cause)
cause.code          <- unique(Data.fig$Cause)
cause.lab <- paste(cause.name.vec,'(',as.character(round(Total.cause$Contribution,2)),')')
text.1 <- paste('Numbers in boxes are age-specific contributions')
# Better to do separately to get the subtotal by causes of death
ed.males1 <- ggplot(Data.fig, aes(x = Age, y = Contribution, fill = Cause)) +
ggtitle(paste0('A ',Initial,'-',Final), subtitle = bquote( e[.(Initial)]^"\u2020" == .(e01)~',' ~ e[.(Final)]^"\u2020" == .(e02) ~'. Difference in'~ e^"\u2020" ==.(dife0) ) )+
scale_fill_manual(name= ' Cause of death (Contribution)',values=base2,labels = cause.lab)+
ylim(-.7, .12)+
geom_bar(aes(group = Cause), stat = "identity",position = "stack")+
theme_light()+
geom_label(aes(Age, -.7, label = Contribution,fill=NULL),size=3,show.legend = FALSE, data = Total.Age)+
theme(text = element_text(size=12),
axis.text.x = element_text(angle=45, hjust=1))+
labs(x = "Age group", y = "Contribution (years)",size=12)+
theme(axis.title.y = element_text(size = 12, angle = 90))+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(legend.position = c(.35,.75))+
annotate("text", x=-Inf, y=-Inf,hjust=1,vjust=1, label= text.1,size=6) +
geom_hline(yintercept = 0)+coord_flip()
#scale_x_discrete(position = "top")
ed.males1
#Now 2005-2015
State   <- 'National'
Initial <- 2005
Final   <- 2015
sex     <- 'Males'
Data.fig        <- getData.function.g(Data2 = DT.Decomp.ed,state = State,initial = Initial,final = Final)
Data.fig$Period <- paste0(Initial,'-',Final)
Data.fig        <- Data.fig[Data.fig$Sex == sex,]
# Get life expectancies
e01     <- round(DT.LTmx[DT.LTmx$state.name == State & DT.LTmx$year ==  Initial& DT.LTmx$sex == 'Males']$e.dagger[1],2)
e02     <- round(DT.LTmx[DT.LTmx$state.name == State & DT.LTmx$year ==  Final& DT.LTmx$sex == 'Males']$e.dagger[1],2)
dife0   <- e02-e01
Total.cause <- Data.fig[,list(Contribution = sum(Contribution)), by = list(Cause)]
sum(Total.cause$Contribution)
Total.Age <- Data.fig[,list(Contribution = sum(Contribution)), by = list(Age)]
sum(Total.Age$Contribution)
Total.Age$Contribution <- round(Total.Age$Contribution,2)
ylim1 <- min(Data.fig$Contribution)
cause.name.vec      <- levels(Data.fig$Cause)
cause.code          <- unique(Data.fig$Cause)
cause.lab <- paste(cause.name.vec,'(',as.character(round(Total.cause$Contribution,2)),')')
text.1 <- paste('Numbers in boxes are age-specific contributions')
# Better to do separately to get the subtotal by causes of death
ed.males2 <- ggplot(Data.fig, aes(x = Age, y = Contribution, fill = Cause)) +
ggtitle(paste0('B ',Initial,'-',Final), subtitle = bquote( e[.(Initial)]^"\u2020" == .(e01)~',' ~ e[.(Final)]^"\u2020" == .(e02) ~'. Difference in'~ e^"\u2020" == .(dife0) ) )+
ylim(-.7, .12)+
scale_fill_manual(name= ' Cause of death (Contribution)',values=base2,labels = cause.lab)+
geom_bar(aes(group = Cause), stat = "identity",position = "stack")+
theme_light()+
geom_label(aes(Age, -.7, label = Contribution,fill=NULL),size=3,show.legend = FALSE, data = Total.Age)+
theme(text = element_text(size=12),
axis.text.x = element_text(angle=45, hjust=1))+
labs(x = "Age group", y = "Contribution (years)",size=12)+
theme(axis.title.y = element_text(size = 12, angle = 90))+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(legend.position = c(.35,.75))+
annotate("text", x=-Inf, y=-Inf,hjust=1,vjust=1, label= text.1,size=6) +
geom_hline(yintercept = 0)+coord_flip()
#scale_x_discrete(position = "top")
ed.males2
base2 <- c(1:15)
base2 <- c(rev(brewer.pal(8,name = 'Spectral'))[1:5],rev(brewer.pal(8,name = 'Spectral'))[8],rev(brewer.pal(8,name = 'Spectral'))[7],'lightgrey')
# Changes in life expectancy by period for males ------------------------------------
final.y <- 2015
Sex     <- 'Males'
Changes.data   <- DT.LTmx[DT.LTmx$year %in% c(1995,2005,final.y) & DT.LTmx$age == 0 & DT.LTmx$state.name!= 'National',]
Changes.data   <- Changes.data[order(state, sex, year),]
Dif.data.state <- Changes.data[, list(Difference=diff(ex)), by = list(state.name,region,sex,state)]
Dif.data.state$Difference.ed <- Changes.data[, list(Difference.ed=diff(e.dagger)), by = list(state.name,region,sex,state)]$Difference.ed
Dif.data.state <- Dif.data.state[,Period := c('1995-2005',paste0(2005,'-',final.y)), by = list(state.name,region,sex,state)]
Dif.data.state <- Dif.data.state[,Ref.order := rep(Difference[2],2), by = list(state.name,region,sex,state)]
Dif.data.state <- Dif.data.state[Dif.data.state$sex == Sex,]
Dif.data.state$region <- factor(Dif.data.state$region,levels = rev(levels(Dif.data.state$region)))
head(Dif.data.state)
Dif.data.state$state.name <- reorder(Dif.data.state$state.name,Dif.data.state$Ref.order)
changes.ex.males <- ggplot(Dif.data.state, aes(Difference, state.name)) +
ggtitle(bquote('A Changes in state male life expectancy '~(e[0])), subtitle = 'by period')+
geom_vline(xintercept = 0)+
geom_point(data = Dif.data.state, aes(Difference, state.name,col=Period, shape=Period),size = 3) +
facet_grid(region ~., scales = "free", space = "free") +
theme_light()+
scale_color_manual(values=base2[c(1,6)])+
theme(axis.title.y=element_blank())+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(strip.text.y = element_text(colour = "black"))+
theme(legend.position = 'bottom')
changes.ex.males
changes.ed.males <- ggplot(Dif.data.state, aes(Difference.ed, state.name)) +
ggtitle(bquote('B Changes in state male lifespan variation '~(e^"\u2020")), subtitle = 'by period')+
geom_vline(xintercept = 0)+
geom_point(data = Dif.data.state, aes(Difference.ed, state.name,col=Period, shape=Period),size = 3) +
facet_grid(region ~., scales = "free", space = "free") +
xlab("Difference") +
theme_light()+
scale_color_manual(values=base2[c(1,6)])+
theme(axis.title.y=element_blank())+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(strip.text.y = element_text(colour = "black"))+
theme(legend.position ='bottom')
changes.ed.males
final   <- 2015
ex.COD_state.1995.2005 <- get.data.function2(Data2 = DT.Decomp.ex,initial =1995,final = 2005)
ex.COD_state.1995.2005$Period <- '1995-2005'
ex.COD_state.2005.2015 <- get.data.function2(Data2 = DT.Decomp.ex,initial =2005,final = final)
ex.COD_state.2005.2015$Period <-  paste0('2005-',final)
COD.state.ex <- rbind(ex.COD_state.1995.2005,ex.COD_state.2005.2015)
COD.state.ex <- COD.state.ex[,list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,Cause,Period)]
COD.state.ex <- COD.state.ex[COD.state.ex$Name != 'National',]
##### do figures for males
sex          <- 'Males'
COD.state.ex <- COD.state.ex[COD.state.ex$Sex == sex,]
ref.order    <- COD.state.ex[COD.state.ex$Period == paste0('2005-',final),]
ref.order    <- ref.order[,list(ref.order = rep(Contribution[6],8)), by = list(Name,Region,Sex,State)]
ref.order    <- ref.order[order(Name),]
COD.state.ex <- COD.state.ex[order(Period,Name),]
COD.state.ex$Ref.order <- c(ref.order$ref.order,ref.order$ref.order)
COD.state.ex$Region <- factor(COD.state.ex$Region,levels = rev(levels(COD.state.ex$Region)))
COD.state.ex$Name <- reorder(COD.state.ex$Name,COD.state.ex$Ref.order)
unique(COD.state.ex$Cause)
COD.ex.fig <- COD.state.ex[COD.state.ex$Cause %in% unique(COD.state.ex$Cause)[c(1,2,6,7)], ]
changes.COD.males.ex <- ggplot(COD.ex.fig, aes(Contribution, Name)) +
ggtitle(bquote('Cause-specific contributions to the change in '~(e[0])), subtitle =bquote('Negative values decrease '~(e[0])~' and positive values increase '~(e[0])) )+
geom_vline(xintercept = 0)+
xlim(c(-2,2))+
geom_point(data = COD.ex.fig, aes(Contribution, Name,col=Period, shape=Period),size = 3) +
facet_grid(Region ~ Cause, scales = "free", space = "free") +
theme_light()+
scale_color_manual(values=base2[c(1,6)])+
theme(axis.title.y=element_blank())+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(strip.text.y = element_text(colour = "black"))+
theme(legend.position = 'bottom')
changes.COD.males.ex
get.data.function2 <-  function(Data2 = DT.Decomp.ex,initial = initial.ind,final = final.ind){
Data <- cbind(Data2[,1:6], AMS = rowSums(Data2[,c(7,10,8,9,12)]), Diabetes = Data2[,c(11)], IHD = Data2[,c(13)],
LungCancer = Data2[,c(16)], Cirrhosis = Data2[,c(17)],Homicide = Data2[,c(18)],TAcc = Data2[,c(19)],
Rest = rowSums(Data2[,c(14,21,15,20,22)]))
colnames(Data) <- c('Name','Region','Sex','State','year','age1',1:8)
Data.melt               <- melt(Data, id.vars = 1:6,variable.name = 'Cause',value.name = 'Contribution')
levels(Data.melt$Cause) <- c('AMS','Diabetes','IHD','Lung Cancer','Cirrhosis',
'Homicide','Traffic accidents','Rest')
Data.melt <- Data.melt[Data.melt$age1 < 100,]
Labels.age            <- c('0-4', '5-9', '10-14', '15-19', '20-24','25-29','30-34','35-39',
'40-44','45-49','50-54','55-59','60-64','65-69',
"70-74","75-79","80-84","85-89","90-94","95+")
Data.melt$Age       <- (cut(Data.melt$age1+1, breaks=c(seq(0,95,5),Inf),labels=Labels.age))
Data.melt5 <- Data.melt[,list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,year,Cause,Age)]
Data.fig   <- Data.melt5[Data.melt5$year >= initial & Data.melt5$year < final, ]
Data.fig   <- Data.fig[, list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,Cause,Age)]
Data.fig
}
#get data
final   <- 2015
ex.COD_state.1995.2005 <- get.data.function2(Data2 = DT.Decomp.ex,initial =1995,final = 2005)
ex.COD_state.1995.2005$Period <- '1995-2005'
ex.COD_state.2005.2015 <- get.data.function2(Data2 = DT.Decomp.ex,initial =2005,final = final)
ex.COD_state.2005.2015$Period <-  paste0('2005-',final)
COD.state.ex <- rbind(ex.COD_state.1995.2005,ex.COD_state.2005.2015)
COD.state.ex <- COD.state.ex[,list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,Cause,Period)]
COD.state.ex <- COD.state.ex[COD.state.ex$Name != 'National',]
##### do figures for males
sex          <- 'Males'
COD.state.ex <- COD.state.ex[COD.state.ex$Sex == sex,]
ref.order    <- COD.state.ex[COD.state.ex$Period == paste0('2005-',final),]
ref.order    <- ref.order[,list(ref.order = rep(Contribution[6],8)), by = list(Name,Region,Sex,State)]
ref.order    <- ref.order[order(Name),]
COD.state.ex <- COD.state.ex[order(Period,Name),]
COD.state.ex$Ref.order <- c(ref.order$ref.order,ref.order$ref.order)
COD.state.ex$Region <- factor(COD.state.ex$Region,levels = rev(levels(COD.state.ex$Region)))
COD.state.ex$Name <- reorder(COD.state.ex$Name,COD.state.ex$Ref.order)
unique(COD.state.ex$Cause)
COD.ex.fig <- COD.state.ex[COD.state.ex$Cause %in% unique(COD.state.ex$Cause)[c(1,2,6,7)], ]
changes.COD.males.ex <- ggplot(COD.ex.fig, aes(Contribution, Name)) +
ggtitle(bquote('Cause-specific contributions to the change in '~(e[0])), subtitle =bquote('Negative values decrease '~(e[0])~' and positive values increase '~(e[0])) )+
geom_vline(xintercept = 0)+
xlim(c(-2,2))+
geom_point(data = COD.ex.fig, aes(Contribution, Name,col=Period, shape=Period),size = 3) +
facet_grid(Region ~ Cause, scales = "free", space = "free") +
theme_light()+
scale_color_manual(values=base2[c(1,6)])+
theme(axis.title.y=element_blank())+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(strip.text.y = element_text(colour = "black"))+
theme(legend.position = 'bottom')
changes.COD.males.ex
changes.COD.males.ex2 <- ggplot(COD.state.ex, aes(Contribution, Name)) +
ggtitle(bquote('Cause-specific contributions to the change in '~(e[0])), subtitle =bquote('Negative values decrease '~(e[0])~' and positive values increase '~(e[0])) )+
geom_vline(xintercept = 0)+
xlim(c(-2,2))+
geom_point(data = COD.state.ex, aes(Contribution, Name,col=Period, shape=Period),size = 3) +
facet_grid(Region ~ Cause, scales = "free", space = "free") +
theme_light()+
scale_color_manual(values=base2[c(1,6)])+
theme(axis.title.y=element_blank())+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(strip.text.y = element_text(colour = "black"))+
theme(legend.position = 'bottom')
changes.COD.males.ex2
#get data
final   <- 2015
ex.COD_state.1995.2005 <- get.data.function2(Data2 = DT.Decomp.ex,initial =1995,final = 2005)
ex.COD_state.1995.2005$Period <- '1995-2005'
ex.COD_state.2005.2015 <- get.data.function2(Data2 = DT.Decomp.ex,initial =2005,final = final)
ex.COD_state.2005.2015$Period <-  paste0('2005-',final)
COD.state.ex <- rbind(ex.COD_state.1995.2005,ex.COD_state.2005.2015)
COD.state.ex <- COD.state.ex[,list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,Cause,Period)]
COD.state.ex <- COD.state.ex[COD.state.ex$Name != 'National',]
##### do figures for males
sex          <- 'Females'
COD.state.ex <- COD.state.ex[COD.state.ex$Sex == sex,]
COD.state.ex <- COD.state.ex[order(Period,Name),]
COD.state.ex$Ref.order <- c(ref.order$ref.order,ref.order$ref.order)
COD.state.ex$Region <- factor(COD.state.ex$Region,levels = rev(levels(COD.state.ex$Region)))
COD.state.ex$Name <- reorder(COD.state.ex$Name,COD.state.ex$Ref.order)
### for the appendix
changes.COD.females.ex2 <- ggplot(COD.state.ex, aes(Contribution, Name)) +
ggtitle(bquote('Cause-specific contributions to the change in '~(e[0])), subtitle =bquote('Negative values decrease '~(e[0])~' and positive values increase '~(e[0])) )+
geom_vline(xintercept = 0)+
xlim(c(-2,2))+
geom_point(data = COD.state.ex, aes(Contribution, Name,col=Period, shape=Period),size = 3) +
facet_grid(Region ~ Cause, scales = "free", space = "free") +
theme_light()+
scale_color_manual(values=base2[c(1,6)])+
theme(axis.title.y=element_blank())+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(strip.text.y = element_text(colour = "black"))+
theme(legend.position = 'bottom')
changes.COD.females.ex2
#get data
final   <- 2015
ed.COD_state.1995.2005 <- get.data.function2(Data2 = DT.Decomp.ed,initial =1995,final = 2005)
ed.COD_state.1995.2005$Period <- '1995-2005'
ed.COD_state.2005.2015 <- get.data.function2(Data2 = DT.Decomp.ed,initial =2005,final = final)
ed.COD_state.2005.2015$Period <-  paste0('2005-',final)
COD.state.ed <- rbind(ed.COD_state.1995.2005,ed.COD_state.2005.2015)
COD.state.ed <- COD.state.ed[,list(Contribution = sum(Contribution)), by = list(Name,Region,Sex,State,Cause,Period)]
COD.state.ed <- COD.state.ed[COD.state.ed$Name != 'National',]
##### do figures for males
sex          <- 'Males'
COD.state.ed <- COD.state.ed[COD.state.ed$Sex == sex,]
COD.state.ed <- COD.state.ed[order(Period,Name),]
COD.state.ed$Ref.order <- c(ref.order$ref.order,ref.order$ref.order)
COD.state.ed$Region <- factor(COD.state.ed$Region,levels = rev(levels(COD.state.ed$Region)))
COD.state.ed$Name <- reorder(COD.state.ed$Name,COD.state.ed$Ref.order)
######
unique(COD.state.ed$Cause)
COD.ex.fig <- COD.state.ed[COD.state.ed$Cause %in% unique(COD.state.ed$Cause)[c(1,2,6,7)], ]
changes.COD.males.ed <- ggplot(COD.ex.fig, aes(Contribution, Name)) +
ggtitle(bquote('Cause-specific contributions to the change in '~(e^"\u2020")), subtitle = bquote('Negative values decrease '~(e^"\u2020")~' and positive values increase '~(e^"\u2020")) )+
geom_vline(xintercept = 0)+
xlim(c(-1.25,1))+
geom_point(data = COD.ex.fig, aes(Contribution, Name,col=Period, shape=Period),size = 3) +
facet_grid(Region ~ Cause, scales = "free", space = "free") +
theme_light()+
scale_color_manual(values=base2[c(1,6)])+
theme(axis.title.y=element_blank())+
theme(axis.title.x = element_text(size = 12, angle = 00))+
theme(text = element_text(size=14),
strip.text.x = element_text(size = 14, colour = "black"))+
theme(strip.text.y = element_text(colour = "black"))+
theme(legend.position = 'bottom')
changes.COD.males.ed
